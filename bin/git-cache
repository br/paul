#!/bin/bash

function git_cache {
  local git_port="$1"; shift
  local nm_remote="$1"; shift

  local pth_sentinel="$(ssh $nm_remote mktemp -t XXXXXXX)"

  rm -f $git_port.txt
  ssh -o ExitOnForwardFailure=yes -R0:localhost:$git_port -f $nm_remote bin/sleep_until $pth_sentinel > $git_port.txt 2>&1
  remote_port="$(awk '$1 == "Allocated" { print $3 }' $git_port.txt)"
  rm -f $git_port.txt

  ssh $nm_remote mkdir -p .cache

  ssh $nm_remote "cd .cache && git init"
  ssh $nm_remote "cd .cache && git remote add cache git://localhost:$remote_port/"
  ssh $nm_remote "cd .cache && git fetch cache"
  ssh $nm_remote "cd .cache && git reset --hard cache/master"
  ssh $nm_remote "cd .cache && git remote rm cache"

  ssh $nm_remote rm -f $pth_sentinel
}

if [[ -z "$_HF_CACHE" ]]; then
  export _HF_CACHE=1
  git serve "$@"
else
  git_cache "$@"
fi
