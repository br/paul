#!/bin/bash

function git_cache {
  local git_port="$1"; shift
  local nm_remote="$1"; shift

  rm -f $git_port.txt
  ssh -o ExitOnForwardFailure=yes -R0:localhost:$git_port -f $nm_remote sleep 60 > $git_port.txt 2>&1
  remote_port="$(awk '$1 == "Allocated" { print $3 }' $git_port.txt)"
  rm -f $git_port.txt

  pth_git=".cache/$(basename "$(git config --list | grep remote.origin.url | cut -d= -f2-)")"
  ssh $nm_remote mkdir -p "$pth_git"

  ssh $nm_remote "cd $pth_git && git init --bare && git remote add cache git://localhost:$remote_port/"
  ssh $nm_remote "cd $pth_git && git fetch cache && git remote rm cache"
}

if [[ -z "$_HF_CACHE" ]]; then
  export _HF_CACHE=1
  git serve "$@"
else
  git_cache "$@"
fi
